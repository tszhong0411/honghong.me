---
title: å¦‚ä½•ä½¿ç”¨ Next.js å’Œ MDX å»ºç«‹éƒ¨è½æ ¼
date: '2022-08-22T00:00:00Z'
modifiedTime: '2022-08-22T00:00:00Z'
summary: ç”¨ Next.js è£½ä½œ Blog éå¸¸ç°¡å–®ï¼
image: 'how-to-build-a-blog-with-nextjs-and-mdx/cover.png'
---

## å‰è¨€

è¦ç”¨åˆ°çš„ packages æœ‰ï¼š

- [next](https://github.com/vercel/next.js) Next.js æ¡†æ¶
- [next-mdx-remote](https://github.com/hashicorp/next-mdx-remote) è™•ç†å’ŒåŠ è¼‰ mdx å…§å®¹
- [gray-matter](https://github.com/jonschlinkert/gray-matter) åˆ†æ markdown ä¸­çš„ front matter

æœ¬æ¬¡æ•™å­¸çš„ repository:

https://github.com/tszhong0411/nextjs-mdx-blog

## æ¨£å“

[ç·šä¸Š](https://hong-nextjs-mdx-blog.vercel.app)

![Demo](/static/images/blog/how-to-build-a-blog-with-nextjs-and-mdx/demo.gif)

## å¦‚ä½•å»ºç«‹ blog

é¦–å…ˆï¼Œæˆ‘å€‘ç”¨ä»¥ä¸‹æŒ‡ä»¤å»ºç«‹ Next.js é …ç›®:

```
yarn create next-app nextjs-mdx-blog
```

æ¥è‘—ï¼Œå†å»ºç«‹ä»¥ä¸‹æª”æ¡ˆ:

- `components\Layout.js` - æŠŠ components éƒ½åŒ…èµ·ä¾†ï¼Œä½œç‚º container çš„ç”¨é€” (å¯é¸ï¼Œåªæ˜¯æ¨£å¼è€Œå·²)
- `date\blog\*.mdx` - éƒ¨è½æ ¼æ–‡ç« 
- `lib\formatDate.js` - æŠŠæ—¥æœŸæ ¼å¼åŒ–ç‚º `YYYYå¹´MMæœˆDDæ—¥`
- `[slug].js` - æ–‡ç« é é¢ï¼Œä½¿ç”¨ [dynamic routes](https://nextjs.org/docs/routing/dynamic-routes)

```
|-- components
|   |-- Layout.js
|-- data
|   |-- blog
|     |-- markdown.mdx
|     |-- nextjs.mdx
|     |-- react.mdx
|-- lib
|   |-- formatDate.js
|   |-- mdx.js
|-- pages
|   |-- blog
|     |-- [slug].js
```

### å¦‚ä½•è™•ç† Markdown æª”æ¡ˆ

<Alert icon='ğŸ’¡' title='æç¤º' color='yellow' radius='md'>
  ä»¥ä¸‹å…§å®¹å¯«åœ¨ `lib\mdx.js` è£¡
</Alert>

å…ˆ `const root` ç‚ºæ ¹ç›®éŒ„ï¼Œ`process.cwd()` æ–¹æ³•è¿”å› Node.js é€²ç¨‹çš„ç•¶å‰å·¥ä½œç›®éŒ„ã€‚

```js
const root = process.cwd()
```

å†å¯«ä¸€å€‹è®Šé‡ `POSTS_PATH` ç‚º æ–‡ç« æª”æ¡ˆå­˜æ”¾çš„è·¯å¾‘ã€‚

```js
import path from 'path'

const POSTS_PATH = path.join(root, 'data', 'blog')
// è¼¸å‡º: A:\nextjs-mdx-blog\data\blog
```

å†ç”¨ fs é–±è®€è®€å–è©²ç›®éŒ„çš„å…§å®¹ï¼Œä¹Ÿå³æ˜¯ `data\blog` ä¸‹çš„æ‰€æœ‰æª”æ¡ˆåç¨±ã€‚

```js
import fs from 'fs'

export const allSlugs = fs.readdirSync(POSTS_PATH)
// è¼¸å‡º: ['markdown.mdx', 'nextjs.mdx', 'react.mdx']
```

ç„¶å¾Œå¯«ä¸€å€‹å¯ä»¥æŠŠå‰¯æª”åç§»é™¤çš„åŠŸèƒ½ï¼Œç­‰ä¸€ä¸‹æœƒç”¨åˆ°ã€‚

```js
export const formatSlug = (slug) => slug.replace(/\.mdx$/, '')
/**
 * ä¾‹å¦‚ formatSlug('markdown.mdx')
 * è¼¸å‡º: 'markdown'
 */
```

æ¥è‘—æ˜¯ç”¨ slug å–å¾—æ–‡ç« å…§å®¹ã€‚

```js
export const getPostBySlug = async (slug) => {
  const postFilePath = path.join(POSTS_PATH, `${slug}.mdx`)
  // è¼¸å‡º: A:\nextjs-mdx-blog\data\blog\slug.mdx
  const source = fs.readFileSync(postFilePath)
  // è¿”å›æª”æ¡ˆå…§å®¹

  const { content, data } = matter(source)
  /*
   * ä¾‹å¦‚:
   *  ---
   *  title: Hello
   *  slug: home
   *  ---
   *  <h1>Hello world!</h1>
   *
   * è¿”å›:
   *  {
   *    content: '<h1>Hello world!</h1>',
   *    data: {
   *      title: 'Hello',
   *      slug: 'home'
   *    }
   *  }
   */

  const mdxSource = await serialize(content)
  // æŠŠ content ä¸Ÿåˆ° serialize (next-mdx-remote) è™•ç†

  const frontMatter = {
    ...data,
    slug,
  }
  // æŠŠ slug ä¹Ÿæ”¾åˆ° front matter ä¸­ï¼Œä¹‹å¾Œæœƒç”¨åˆ°

  return {
    source: mdxSource,
    frontMatter,
  }
}
```

ç„¶å¾Œæ˜¯å–å¾—æ‰€æœ‰æ–‡ç« ï¼Œåœ¨é¦–é ä¸­é¡¯ç¤ºã€‚

```js
export const getAllPosts = () => {
  const frontMatter = []

  allSlugs.forEach((slug) => {
    const source = fs.readFileSync(path.join(POSTS_PATH, slug), 'utf-8')

    const { data } = matter(source)

    frontMatter.push({
      ...data,
      slug: formatSlug(slug),
      date: new Date(data.date).toISOString(),
    })
  })

  return frontMatter.sort((a, b) => dateSortDesc(a.date, b.date))
}

// æ ¹æ“šæ—¥æœŸç”±å¤§è‡³å°æ’åº
const dateSortDesc = (a, b) => {
  if (a > b) return -1
  if (a < b) return 1

  return 0
}
```

### æ ¼å¼åŒ–æ—¥æœŸ

<Alert icon='ğŸ’¡' title='æç¤º' color='yellow' radius='md'>
  ä»¥ä¸‹å…§å®¹å¯«åœ¨ `lib\formatDate.js` è£¡
</Alert>

```js
export const formatDate = (date) =>
  new Date(date).toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })
/*
 * formatDate('2022-08-21T00:00:00Z')
 * è¼¸å‡º: '2022å¹´8æœˆ21æ—¥'
 */
```

### é¦–é 

<Alert icon='ğŸ’¡' title='æç¤º' color='yellow' radius='md'>
  ä»¥ä¸‹å…§å®¹å¯«åœ¨ `pages\index.js` è£¡
</Alert>

```jsx
import { formatDate } from '../lib/formatDate'
import { getAllPosts } from '../lib/mdx'

import Link from 'next/link'

export default function Home({ posts }) {
  return (
    <>
      <h1 className='text-6xl font-bold mb-8'>Blog</h1>
      <hr className='my-8' />
      <ul className='flex flex-col gap-3'>
        {posts.map(({ slug, title, summary, date }) => (
          <li key={slug}>
            <Link href={`/blog/${slug}`}>
              <a className='border border-solid border-gray-300 rounded-lg shadow-md p-6 block'>
                <div className='flex justify-between'>
                  <h2>{title}</h2>
                  <time dateTime={date}>{formatDate(date)}</time>
                </div>
                <p className='mt-4'>{summary}</p>
              </a>
            </Link>
          </li>
        ))}
      </ul>
    </>
  )
}

// ä½¿ç”¨ getStaticProps å–å¾—æ‰€æœ‰æ–‡ç« 
export const getStaticProps = async () => {
  const posts = getAllPosts()

  return {
    props: {
      posts,
    },
  }
}
```

### æ–‡ç« é é¢

<Alert icon='ğŸ’¡' title='æç¤º' color='yellow' radius='md'>
  ä»¥ä¸‹å…§å®¹å¯«åœ¨ `pages\[slug].js` è£¡
</Alert>

```jsx
import { formatDate } from '../../lib/formatDate'
import { allSlugs, formatSlug, getPostBySlug } from '../../lib/mdx'

import { MDXRemote } from 'next-mdx-remote'

export default function Blog({ post }) {
  const { title, date } = post.frontMatter

  return (
    <div>
      <h1 className='font-bold text-6xl mb-2'>{title}</h1>
      <time dateTime={date} className='text-lg font-medium'>
        {formatDate(date)}
      </time>
      <hr className='my-8' />
      <article className='prose'>
        <MDXRemote {...post.source} />
      </article>
    </div>
  )
}

export const getStaticProps = async ({ params }) => {
  const post = await getPostBySlug(params.slug)

  return {
    props: {
      post,
    },
  }
}

export const getStaticPaths = async () => {
  const paths = allSlugs.map((slug) => ({
    params: {
      slug: formatSlug(slug),
    },
  }))
  /*
   * paths è¼¸å‡º:
   *   [
   *     { params: { slug: 'markdown' } },
   *     { params: { slug: 'nextjs' } },
   *     { params: { slug: 'react' } }
   *   ]
   */

  return {
    paths,
    fallback: false,
  }
}
```

é€™æ¨£ç°¡æ˜“çš„ Blog å°±å¤§åŠŸå‘Šæˆäº†ã€‚

## å¯¦ç”¨é€£çµ

- [getStaticPaths](https://nextjs.org/docs/basic-features/data-fetching/get-static-paths)
- [getStaticProps](https://nextjs.org/docs/basic-features/data-fetching/get-static-props)
- [Dynamic Routes](https://nextjs.org/docs/routing/dynamic-routes)
- [mdx](https://mdxjs.com/)
